# Conversation ID vs. Stream ID: Architectural Roles

This document explains the purpose and usage of `conversation_id` and `stream_id` within the application.

## 1. Conversation ID (`conversation_id`)

The `conversation_id` is a **persistent session identifier**. It represents a single chat thread between a user and the AI.

### Lifecycle & Generation
- **New Chats**: When a user first visits the application, they are on a "new" chat state (URL: `/`). The initial `conversation_id` is the literal string `"new"`.
- **First Message**: When the first message is sent, the backend (`main.py`) generates a unique **UUID v4** (e.g., `550e8400-e29b-41d4-a716-446655440000`) and replaces `"new"` with this ID.
- **Persistence**: This ID is used as the key in the server-side `chats` dictionary to store message history, selected model, and provider settings.

### Usage
- **Routing**: HTMX uses it to route requests to the correct conversation (e.g., `POST /chat/{conversation_id}/send-message`).
- **Sidebar**: The sidebar uses these IDs to link to historical conversations and highlight the currently active one.
- **SPA Navigation**: Clicking a conversation in the sidebar triggers an HTMX load of that ID's history without a full page refresh.

---

## 2. Stream ID (`stream_id`)

The `stream_id` is a **transient UI identifier**. It is used specifically to coordinate real-time streaming updates between the backend and the frontend.

### Lifecycle & Generation
- **Generation**: A new `stream_id` (a short 8-character random string derived from a UUID) is generated by the backend every time a route is accessed or a message is sent.
- **Transience**: Unlike the `conversation_id`, the `stream_id` is **never stored** in the database. It exists only for the duration of a single page render or a single streaming event.

### Usage
- **DOM Targeting**: In `templates/chat_stream.html`, the `stream_id` is appended to element IDs (e.g., `<div id="stream-content-{{ stream_id }}">`).
- **SSE Coordination**: The JavaScript `EventSource` listener uses the `stream_id` to know exactly which DOM element it should update with incoming text tokens. This ensures that even if multiple updates are happening, the tokens are injected into the correct message bubble.
- **Resumption**: If a user reloads the page while a message is still generating, the backend generates a *new* `stream_id`, which the frontend then uses to reconnect to the ongoing SSE stream.

---

## Summary Comparison

| Feature | Conversation ID | Stream ID |
| :--- | :--- | :--- |
| **Type** | UUID (Persistent) | Short UUID (Transient) |
| **Storage** | Server-side dictionary (`chats`) | None (In-memory only for rendering) |
| **Primary Goal** | Identify the chat thread | Target the correct UI element for SSE |
| **Scope** | Global (entire chat history) | Local (one specific bot response) |
