<form id="chatForm" hx-encoding="multipart/form-data" hx-post="/chat/{{ conversation_id }}/send-message"
    hx-trigger="submit" hx-target="#new-messages" hx-swap="beforeend" 
    class="relative bg-transparent"
    _="on htmx:afterRequest 
      set #messageInput.value to '' 
      set #messageInput.style.height to 'auto'
      set #fileInput.value to ''
      set #filePreview.innerHTML to ''">

    <div class="neo-card bg-[#282828] p-2 border-[#504945]">
        <!-- File Preview Area -->
        <div id="filePreview" class="px-2 flex flex-wrap gap-2 empty:hidden pb-2 mb-2 border-b border-[#3c3836]"></div>

        <div class="flex items-end gap-2">
            <!-- Attach Button -->
            <button type="button"
                class="flex-shrink-0 w-10 h-10 flex items-center justify-center text-[#a89984] hover:text-[#ebdbb2] transition-colors"
                onclick="document.getElementById('fileInput').click()">
                <span class="material-symbols-rounded text-xl">add_circle</span>
            </button>

            <!-- Auto-expanding Textarea -->
            <textarea id="messageInput" name="message" placeholder="Type your message..." rows="1"
                class="flex-1 bg-transparent text-[#ebdbb2] placeholder-[#7c6f64] resize-none outline-none py-2 px-1 max-h-48 overflow-y-auto font-sans text-base"
                style="height: auto;" _="on input 
            set my.style.height to 'auto' 
            set my.style.height to my.scrollHeight + 'px'
            on keydown if event.key is 'Enter' and not event.shiftKey
            halt the event
            trigger submit on #chatForm
            end"></textarea>

            <!-- Send Button -->
            <button type="submit"
                class="btn-primary w-10 h-10 flex items-center justify-center !p-0">
                <span class="material-symbols-rounded text-xl">arrow_upward</span>
            </button>
        </div>
    </div>

    <!-- Hidden file input -->
    <input type="file" id="fileInput" name="files" accept="image/*,.pdf" class="hidden" multiple>

    <script>
        document.getElementById('fileInput').addEventListener('change', function (e) {
            let files = Array.from(e.target.files);
            const preview = document.getElementById('filePreview');
            preview.innerHTML = '';

            files.forEach((file) => {
                const container = document.createElement('div');
                container.className = "relative inline-flex items-center gap-2 bg-gray-50 border border-black p-2 pr-8 shadow-[2px_2px_0px_#000]";
                
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = function (event) {
                        container.innerHTML = `
                            <img src="${event.target.result}" class="h-8 w-8 object-cover border border-black" alt="Preview">
                            <span class="text-[10px] font-mono truncate max-w-[80px]">${file.name}</span>
                            <button type="button" class="absolute right-1 top-1/2 -translate-y-1/2 text-black hover:text-red-600">
                                <span class="material-symbols-rounded text-sm">close</span>
                            </button> `;
                        
                        container.querySelector("button").onclick = () => {
                            files = files.filter(f => f !== file);
                            const dt = new DataTransfer();
                            files.forEach(f => dt.items.add(f));
                            document.getElementById('fileInput').files = dt.files;
                            container.remove();
                        };
                    };
                    reader.readAsDataURL(file);
                } else {
                    container.innerHTML = `
                        <span class="material-symbols-rounded text-sm">description</span>
                        <span class="text-[10px] font-mono truncate max-w-[80px]">${file.name}</span>
                        <button type="button" class="absolute right-1 top-1/2 -translate-y-1/2 text-black hover:text-red-600">
                            <span class="material-symbols-rounded text-sm">close</span>
                        </button> `;
                    
                    container.querySelector("button").onclick = () => {
                        files = files.filter(f => f !== file);
                        const dt = new DataTransfer();
                        files.forEach(f => dt.items.add(f));
                        document.getElementById('fileInput').files = dt.files;
                        container.remove();
                    };
                }
                preview.appendChild(container);
            });
        });
    </script>
</form>
