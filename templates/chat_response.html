<div id="message-{{ msg_index }}"
    class="message-container flex flex-col gap-2 mb-4 {% if sender == 'user' %}items-end{% else %}items-start{% endif %}"
    data-msg-index="{{ msg_index }}" data-sender="{{ sender }}">
    <div id="message-bubble-{{ msg_index }}"
        class="max-w-[80%] {% if sender == 'user' %} bg-zinc-800 text-white rounded-t-2xl rounded-bl-2xl shadow-md {% else %}bg-zinc-900 text-gray-100 rounded-t-2xl rounded-br-2xl{% endif %} p-2">
        {% if message %}
        <p class="text-sm leading-relaxed whitespace-pre-wrap" _="on load renderMessage(me)">{{ message }}</p>
        {% endif %}

        {% if files %}
        <div class="mt-3 flex flex-wrap gap-2">
            {% for file in files %}
            {% if file.type.startswith('image/') %}
            <img src="{{ file.url }}" class="max-h-48 rounded-lg border border-gray-700 shadow-sm" alt="Attached Image">
            {% else %}
            <div class="flex items-center gap-2 bg-black/20 p-2 rounded-lg text-xs">
                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                        d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span>{{ file.name }}</span>
            </div>
            {% endif %}
            {% endfor %}
        </div>
        {% endif %}
    </div>

    <!-- Edit Mode (Initially Hidden) -->
    <div id="edit-container-{{ msg_index }}"
        class="hidden w-full max-w-[80%] {% if sender == 'user' %}self-end{% else %}self-start{% endif %}">
        <textarea id="edit-textarea-{{ msg_index }}"
            class="w-full bg-zinc-800 text-white text-sm p-3 rounded-xl border border-blue-500 outline-none resize-none min-h-[100px]"
            data-original="{{ message }}">{{ message }}</textarea>
        <div class="flex gap-2 mt-2 {% if sender == 'user' %}justify-end{% else %}justify-start{% endif %}">
            <button class="px-3 py-1 text-sm bg-zinc-700 hover:bg-zinc-600 text-gray-300 rounded-lg transition-colors"
                _="on click
                    add .hidden to #edit-container-{{ msg_index }}
                    remove .hidden from #message-bubble-{{ msg_index }}
                    remove .hidden from <.message-actions/> in #message-{{ msg_index }}">Cancel</button>
            <button class="px-3 py-1 text-sm bg-blue-600 hover:bg-blue-500 text-white rounded-lg transition-colors"
                hx-patch="/chat/{{ conversation_id }}/message/{{ msg_index }}" hx-ext="json-enc"
                hx-vals='js:{"content": document.getElementById("edit-textarea-{{ msg_index }}").value}'
                hx-target="#new-messages" hx-swap="innerHTML">Save</button>
        </div>
    </div>

    <!-- Message Actions -->
    <div class="message-actions {% if sender == 'user' %}flex-row-reverse{% endif %}">
        {% if sender == 'user' %}
        <button class="action-btn" title="Edit" _="on click
            add .hidden to #message-bubble-{{ msg_index }}
            add .hidden to my parentElement
            remove .hidden from #edit-container-{{ msg_index }}
            focus() on #edit-textarea-{{ msg_index }}">âœï¸</button>
        <button class="action-btn" title="Copy" data-message="{{ message }}"
            _="on click copyMessage(me, my.getAttribute('data-message'))">ğŸ“‹</button>
        {% else %}
        <button class="action-btn" title="Copy" data-message="{{ message }}"
            _="on click copyMessage(me, my.getAttribute('data-message'))">ğŸ“‹</button>
        <button class="action-btn" title="Edit" _="on click
            add .hidden to #message-bubble-{{ msg_index }}
            add .hidden to my parentElement
            remove .hidden from #edit-container-{{ msg_index }}
            focus() on #edit-textarea-{{ msg_index }}">âœï¸</button>
        <button class="action-btn" title="Regenerate">â™»ï¸</button>
        {% endif %}
    </div>

    <!-- <span class="text-[10px] text-gray-500 px-1">{{ timestamp if timestamp else 'Just now' }}</span> -->
</div>