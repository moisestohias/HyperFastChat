<!-- Streaming Bot Response Container -->
<!-- Uses native EventSource for reliable streaming with Markdown rendering -->
<div id="stream-container-{{ stream_id }}" class="flex flex-col gap-2 mb-4 items-start">

    <div class="max-w-[80%] bg-gray-800 text-gray-100 rounded-t-2xl rounded-br-2xl p-2 shadow-md">
        <!-- Streaming content target -->
        <div id="stream-content-{{ stream_id }}" class="text-sm leading-relaxed markdown-content">
            {{ message if message else '' }}<span class="stream-cursor animate-pulse text-blue-400">▋</span>
        </div>
    </div>

    <!-- Action buttons - shown when streaming completes -->
    <div id="stream-actions-{{ stream_id }}" class="message-actions hidden"></div>
</div>

<script>
    (function () {
        const streamId = "{{ stream_id }}";
        const convId = "{{ conversation_id }}";
        const contentEl = document.getElementById('stream-content-' + streamId);
        const actionsEl = document.getElementById('stream-actions-' + streamId);

        if (!contentEl) return;

        // Track accumulated raw content - initialized from server-side state
        let rawAccumulated = {{ (message if message else '') | tojson
    }};

    // Create EventSource connection for SSE streaming
    const eventSource = new EventSource('/chat/' + convId + '/bot-stream');

    // Helper to update UI with rendered content and maintain cursor
    const updateUI = (text) => {
        contentEl.textContent = text;
        if (window.renderMessageStreaming) {
            window.renderMessageStreaming(contentEl);
        }

        const cursor = document.createElement('span');
        cursor.className = 'stream-cursor animate-pulse text-blue-400';
        // cursor.textContent = '▋';
        contentEl.appendChild(cursor);

        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    };

    // Initial render if resuming
    if (rawAccumulated) {
        updateUI(rawAccumulated);
    }

    // Handle token events - each event contains the full accumulated text so far
    eventSource.addEventListener('token', function (evt) {
        try {
            rawAccumulated = JSON.parse(evt.data);
        } catch (e) {
            rawAccumulated = evt.data;
        }
        updateUI(rawAccumulated);
    });

    // Handle done event - streaming complete
    eventSource.addEventListener('done', function (evt) {
        eventSource.close();

        // Final full render with all features
        contentEl.textContent = rawAccumulated;
        if (window.renderMessage) {
            window.renderMessage(contentEl);
        }

        // Show action buttons
        try {
            actionsEl.innerHTML = JSON.parse(evt.data);
        } catch (e) {
            actionsEl.innerHTML = evt.data;
        }
        actionsEl.classList.remove('hidden');

        if (window._hyperscript) {
            window._hyperscript.processNode(actionsEl);
        }

        const chatMessages = document.getElementById('chat-messages');
        if (chatMessages) {
            chatMessages.scrollTop = chatMessages.scrollHeight;
        }
    });

    // Handle errors
    eventSource.addEventListener('error', function (evt) {
        eventSource.close();
        console.error('SSE Error:', evt);
    });
    }) ();
</script>