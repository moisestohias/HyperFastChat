<!-- Streaming Bot Response Container -->
<div id="stream-container-{{ stream_id }}" class="message-container flex flex-col gap-1 mb-6 items-start animate-fade-in">
    <!-- Bubble -->
    <div class="max-w-[92%] md:max-w-[85%] neo-card p-2 md:p-3 bg-[#32302f]">
        <!-- Streaming content target -->
        <div id="stream-content-{{ stream_id }}" class="markdown-content text-[#ebdbb2] text-[15px]">
            {{ message if message else '' }}<span class="stream-cursor"></span>
        </div>
    </div>

    <!-- Action buttons - shown when streaming completes (Moved outside) -->
    <div id="stream-actions-{{ stream_id }}" class="message-actions px-1 hidden"></div>
</div>

<script>
    (function () {
        const streamId = "{{ stream_id }}";
        const convId = "{{ conversation_id }}";
        const contentEl = document.getElementById('stream-content-' + streamId);
        const actionsEl = document.getElementById('stream-actions-' + streamId);

        if (!contentEl) return;

        let rawAccumulated = {{ (message if message else '') | tojson }};
        const eventSource = new EventSource('/chat/' + convId + '/bot-stream');

        const updateUI = (text) => {
            contentEl.textContent = text;
            if (window.renderMessageStreaming) {
                window.renderMessageStreaming(contentEl);
            }

            // Create and append the cursor to the last child element to keep it on the same line
            const cursor = document.createElement('span');
            cursor.className = 'stream-cursor';
            
            const lastChild = contentEl.lastElementChild;
            if (lastChild && (lastChild.tagName === 'P' || lastChild.tagName === 'LI')) {
                lastChild.appendChild(cursor);
            } else {
                contentEl.appendChild(cursor);
            }

            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        };

        if (rawAccumulated) {
            updateUI(rawAccumulated);
        }

        eventSource.addEventListener('token', function (evt) {
            try {
                rawAccumulated = JSON.parse(evt.data);
            } catch (e) {
                rawAccumulated = evt.data;
            }
            updateUI(rawAccumulated);
        });

        eventSource.addEventListener('done', function (evt) {
            eventSource.close();
            contentEl.textContent = rawAccumulated;
            if (window.renderMessage) {
                window.renderMessage(contentEl);
            }

            try {
                actionsEl.innerHTML = JSON.parse(evt.data);
            } catch (e) {
                actionsEl.innerHTML = evt.data;
            }
            actionsEl.classList.remove('hidden');

            if (window._hyperscript) {
                window._hyperscript.processNode(actionsEl);
            }

            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                chatMessages.scrollTop = chatMessages.scrollHeight;
            }
        });

        eventSource.addEventListener('error', function (evt) {
            eventSource.close();
            console.error('SSE Error:', evt);
        });
    }) ();
</script>
